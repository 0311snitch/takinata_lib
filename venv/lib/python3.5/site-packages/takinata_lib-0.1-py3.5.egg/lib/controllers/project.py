import os
import logging
import lib.logger as logger
from lib.exception import *
from lib.models.models import Project
from lib.storage.project import ProjectStorage
from lib.storage.user import UserStorage
from lib.controllers.category import CategoryController
from lib.storage.task import TaskStorage
from lib.storage.category import CategoryStorage


class ProjectController:
    """
    The data handler for project. Allows to create/delete, edit name/description of project, add/remove users to/from
    project, return projects tasks of project users.

    """

    log_tag = "ProjectController"
    log = logger.get_logger(log_tag)

    @classmethod
    def create(cls, username, password, name, description):
        """
        Create a project with a specified name and description
        :param username: user, who want to create a new project
        :param password: user password
        :param name: name of new project
        :param description: description of new project
        :return:
        """
        user = UserStorage.get_user_by_name(username)
        if user == None:
            raise NoUser
        if user.password == password:
            projects = ProjectStorage.show_all()
            for project in projects:
                if project.name == name:
                    raise ProjectWithThisNameAlreadyExist
            project = Project(name=name, description=description, user_id=user.id)
            project.users.append(user)
            ProjectStorage.add_project_to_db(project, user)
            ProjectController.log.info("Project {} was successfully created by {}.".format(name, username))
        else:
            ProjectController.log.error("Incorrect password for {}".format(username))
            raise WrongPassword

    @classmethod
    def delete(cls, username, password, name):
        """
        Deletes the project with the specified name
        :param username: user, creator of project
        :param password: user password
        :param name: name of project to delete
        :return:
        """
        user = UserStorage.get_user_by_name(username)
        if user.password == password:
            project = ProjectStorage.get_project_by_name(user, name)
            ProjectStorage.check_permission(user, project)
            guys = ProjectStorage.get_all_persons_in_project_by_id(project)
            for i in guys:
                ProjectController.su_delete_person_from_project(username, password, i, project.id)
            ProjectStorage.delete_with_object(project)
            ProjectController.log.info("Project {} was successfully deleted by {}".format(name, username))
        else:
            ProjectController.log.error("Incorrect password for {}".format(username))
            raise WrongPassword

    @classmethod
    def delete_by_id(cls, username, password, id):
        """
        Deletes the project with the specified id
        :param username: user, creator of project
        :param password: user password
        :param id: project id of project, which will be deleted
        :return:
        """
        user = UserStorage.get_user_by_name(username)
        if user.password == password:
            project = ProjectStorage.get_project_by_id(id)
            ProjectStorage.is_admin(user, project)
            guys = ProjectStorage.get_all_persons_in_project_by_id(project.id)
            categories = CategoryController.show_all(username, password, project)
            for category in categories:
                CategoryStorage.delete_category_from_db(category)
            guys = guys[::-1]
            for i in guys:
                ProjectController.su_delete_person_from_project(username, password, i, project)
            ProjectStorage.delete_with_object(project)
            ProjectController.log.info("Project {} was successfully deleted by {}".format(project.name, username))
        else:
            ProjectController.log.error("Incorrect password for {}".format(username))
            raise WrongPassword

    @classmethod
    def add_person_to_project(cls, username, password, project, person):
        """
        Adds an artist to the project
        :param username: name of project creator
        :param password: creator password
        :param person: the name of the user you want to add to the project
        :param project: instance of project
        :return:
        """
        admin = UserStorage.get_user_by_name(username)
        if person == None:
            raise NoUser
        if admin.password == password:
            if ProjectStorage.is_admin(admin, project):
                userlist = ProjectStorage.get_all_persons_in_project_by_id(project.id)
                have = False
                for user in userlist:
                    if user.id == person.id:
                        have = True
                if have == False:
                    ProjectStorage.add_person_to_project(person, project)
                    ProjectController.log.info("User was successfully added to project")
                else:
                    ProjectController.log.error("User {} is already exist in this project".format(username))
                    raise UserAlreadyExistInProject
            else:
                ProjectController.log.error("You are not the Creator of the project")
                raise UAreNotAdmin
        else:
            ProjectController.log.error("Incorrect password for {}".format(username))
            raise WrongPassword

    @classmethod
    def delete_person_from_project(cls, username, password, project, person):
        """
        The removal of the contractor from the project
        :param username: username of creator
        :param password: creator password
        :param person: person to delete
        :param project: instance of project
        :return:
        """
        admin = UserStorage.get_user_by_name(username)
        if admin.password == password:
            if ProjectStorage.is_admin(admin, project):
                guys = ProjectStorage.get_all_persons_in_project_by_id(project.id)
                have = False
                if guys[0].id == person.id:
                    ProjectController.log.error("{} was tried to delete a creator of the project".format(username))
                    raise CannotDeleteCreator
                for i in range(len(guys)):
                    if guys[i].id == person.id:
                        have = True
                if not have:
                    ProjectController.log.error("User {} is not exist".format(person.username))
                    raise UserIsNotExistInProject
                else:
                    ProjectStorage.delete_person_from_project(person, project)
                    ProjectController.log.info("User {} was successfully deleted from the project")
            else:
                ProjectController.log.error("{} are not the Creator of the project".format(username))
                raise UAreNotAdmin
        else:
            ProjectController.log.error("Incorrect password for {}".format(username))
            raise WrongPassword

    @classmethod
    def su_delete_person_from_project(cls, username, password, person, project):
        """
        Delete all the workers from the project, you can also delete the project Creator
        :param username: name of creator
        :param password: creator password
        :param person: person to delete
        :param project_id: project id
        :return:
        """
        admin = UserStorage.get_user_by_name(username)
        person = UserStorage.get_user_by_id(person.id)
        if admin.password == password:
            ProjectStorage.is_admin(admin, project)
            guys = ProjectStorage.get_all_persons_in_project_by_id(project.id)
            have = False
            for i in range(len(guys)):
                if guys[i].id == person.id:
                    have = True
            if not have:
                ProjectController.log.error("User with id {} is not exist".format(person.id))
                raise UserIsNotExistInProject
            else:
                ProjectStorage.delete_person_from_project(person, project)
                ProjectController.log.info("User {} was sucessfully deleted from the project".format(person.username))
        else:
            ProjectController.log.error("Incorrect password for {}".format(username))
            raise WrongPassword

    @classmethod
    def edit_name_by_id(cls, username, password, project_id, new_name):
        """
        Editing the project name
        :param username: name of project creator
        :param password: creator password
        :param project_name: name of the project to be changed
        :param new_name: new name of project
        :return:
        """
        person = UserStorage.get_user_by_name(username)
        project = ProjectStorage.get_project_by_id(project_id)
        projects = ProjectStorage.show_all_for_user(username, password)
        if person.password == password:
            ProjectStorage.is_admin(person, project)
            for pr in projects:
                if pr.name == new_name:
                    raise ProjectWithThisNameAlreadyExist
            project.name = new_name
            ProjectStorage.save(project)
            ProjectController.log.info("Name of the project {} was successfully edited".format(project.name))
        else:
            ProjectController.log.error("Incorrect password for {}".format(username))
            raise WrongPassword

    @classmethod
    def edit_description_by_id(cls, username, password, project_id, new_desc):
        """
        Editing the project description
        :param username: name of project creator
        :param password: creator password
        :param project_name: name of the project to be changed
        :param new_desc: new description of project
        :return:
        """
        person = UserStorage.get_user_by_name(username)
        project = ProjectStorage.get_project_by_id(project_id)
        if person.password == password:
            ProjectController.is_admin(person, project)
            project.description = new_desc
            ProjectStorage.save(project)
            ProjectController.log.info("Description of the project {} was successfully edited".format(project.name))
        else:
            ProjectController.log.error("Incorrect password for {}".format(username))
            raise WrongPassword

    @classmethod
    def get_project_tasks(cls, username, password, project):
        categories = CategoryController.show_all(username, password, project)
        task_list = []
        for category in categories:
            tasks = TaskStorage.get_all_tasks(category.id)
            task_list = task_list + tasks
        available_tasks = []
        canceled_tasks = []
        for task in task_list:
            if task.is_archive == 0:
                available_tasks.append(task)
            else:
                canceled_tasks.append(task)
        task_list = available_tasks + canceled_tasks
        return task_list

    @classmethod
    def get_users_not_in_project(cls, project_id):
        all_users = UserStorage.get_all_users()
        guys = ProjectStorage.get_all_persons_in_project_by_id(project_id)
        all_guys = []
        guys_names = []
        for i in guys:
            guys_names.append(i.username)
        for i in all_users:
            if i.username not in guys_names:
                all_guys.append(i)
        creator = guys[0]
        guys = guys[1:]
        return creator, guys, all_guys